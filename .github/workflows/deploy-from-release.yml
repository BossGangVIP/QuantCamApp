name: Deploy from Release ZIP

on:
  release:
    types: [published]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare workspace
        run: |
          mkdir -p dist

      - name: Find ZIP asset on this release
        id: findzip
        run: |
          echo "ASSET_URL=$(echo '${{ toJson(github.event.release.assets) }}' \
            | jq -r '[.[] | select(.content_type=="application/zip" or (.name|endswith(".zip")) )][0].browser_download_url')" >> $GITHUB_OUTPUT
          test -n "$(cat $GITHUB_OUTPUT | cut -d= -f2-)" || (echo "No .zip asset found on this release." && exit 1)

      - name: Download ZIP
        run: |
          curl -L -o site.zip "${{ steps.findzip.outputs.ASSET_URL }}"

      - name: Unzip into dist
        run: unzip -q site.zip -d dist

      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
