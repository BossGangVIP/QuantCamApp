<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuantCam</title>
  <style>
    body { margin:0; background:#0b1220; color:#e6f0ff; font-family:sans-serif; text-align:center; }
    h1 { margin:16px 0 4px }
    #status { margin:8px 0; font-size:14px; opacity:.9 }
    video { width:90%; max-width:520px; margin-top:10px; border-radius:12px; background:#000 }
    button { margin:10px; padding:12px 18px; border-radius:10px; border:0; background:#38bdf8; color:#0b1220; font-weight:bold }
    pre { text-align:left; background:#0b1220; border:1px solid #1f2a44; border-radius:10px; padding:10px; max-height:200px; overflow:auto }
  </style>
</head>
<body>
  <h1>QuantCam</h1>
  <p>Point • Shoot • Parse</p>

  <input id="execUrl" placeholder="Paste your Apps Script /exec URL" style="width:90%;padding:10px;border-radius:8px;border:1px solid #1f2a44" />
  <div>
    <button id="enableCam">Enable Camera</button>
    <button id="capture" disabled>Capture → Parse</button>
  </div>

  <div id="status">Waiting…</div>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display:none"></canvas>

  <h3>Parsed Output</h3>
  <pre id="out">(nothing yet)</pre>

<script>
const lsKey = "quantcam_exec_url";
const execInput = document.getElementById("execUrl");
const enableBtn = document.getElementById("enableCam");
const captureBtn = document.getElementById("capture");
const statusEl = document.getElementById("status");
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const out = document.getElementById("out");

// restore saved endpoint
execInput.value = localStorage.getItem(lsKey) || "";
execInput.addEventListener("change", () => {
  localStorage.setItem(lsKey, execInput.value.trim());
});

let stream;
async function enableCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" } }, audio: false
    });
    video.srcObject = stream;
    statusEl.textContent = "Camera ready.";
    captureBtn.disabled = false;
  } catch (e) {
    statusEl.textContent = "Camera error: " + e.name;
  }
}

async function captureAndParse() {
  const url = execInput.value.trim();
  if (!url) { statusEl.textContent = "Paste your /exec URL first."; return; }

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video, 0, 0);

  const dataUrl = canvas.toDataURL("image/png");

  statusEl.textContent = "Sending for parse…";
  out.textContent = "(pending…)";

  try {
    const res = await fetch(url, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ mode:"parse-only", image:dataUrl })
    });
    const text = await res.text();
    try { out.textContent = JSON.stringify(JSON.parse(text), null, 2); }
    catch { out.textContent = text; }
    statusEl.textContent = res.ok ? "Parsed." : "Server error.";
  } catch (err) {
    statusEl.textContent = "Network error.";
    out.textContent = String(err);
  }
}

enableBtn.addEventListener("click", enableCamera);
captureBtn.addEventListener("click", captureAndParse);
</script>
</body>
</html>
