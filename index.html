<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QuantCam</title>
  <style>
    :root { --accent:#2aa8ff; --text:#e8e8e8; --bg:#0e1520; --card:#111a26; }
    * { box-sizing:border-box; }
    html,body { height:100%; margin:0; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg); color: var(--text);
      display:flex; align-items:center; justify-content:center;
      padding:24px;
    }
    .card {
      width:100%; max-width:560px; background:var(--card);
      border-radius:18px; padding:22px; box-shadow:0 10px 30px rgba(0,0,0,.35)
    }
    h1 { margin:0 0 12px; font-size:32px }
    p { margin:0 0 14px; opacity:.85 }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 }
    button, .input {
      border:0; border-radius:10px; padding:12px 16px; font-size:16px;
    }
    button {
      background:var(--accent); color:#001321; font-weight:600; cursor:pointer;
    }
    button.secondary { background:#1f2a38; color:var(--text); }
    input[type="file"] { display:none }
    label.file {
      background:#1f2a38; color:var(--text); cursor:pointer; display:inline-block;
    }
    video, canvas { width:100%; border:2px solid #2b394b; border-radius:10px; }
    .status { margin-top:10px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .ok { color:#67ff9e } .err { color:#ff6a6a }
    small.hint { display:block; opacity:.7; margin-top:10px; line-height:1.4 }
    .tiny { font-size:12px; opacity:.8 }
    .endpoint { word-break:break-all; font-size:12px; opacity:.8; margin-top:6px }
  </style>
</head>
<body>
  <div class="card">
    <h1>QuantCam</h1>
    <p>Point • Shoot • Quant — private test launcher</p>

    <div class="row">
      <button id="openCamera">Open Camera</button>
      <button id="snapSend" class="secondary">Capture &amp; Send</button>
      <button id="pingBtn" class="secondary">Run Ping Test</button>
    </div>

    <video id="cameraFeed" autoplay playsinline></video>
    <canvas id="frame" style="display:none;"></canvas>

    <div class="status" id="status">Ready.</div>
    <div class="endpoint" id="endpoint"></div>
    <small class="hint">
      If Drive/Docs tries to hijack links on Android, long-press the link and choose
      <b>Open in browser</b> or disable “Open supported links” for Drive/Docs in Android settings.
    </small>
    <div class="tiny" style="margin-top:12px">
      Tip: you can override the backend with <code>?exec=YOUR_EXEC_URL</code> in the page URL.
    </div>
  </div>

<script>
/* -------------------- CONFIG (hard-wired; overridable via ?exec=) -------------------- */
// Default backend (your Apps Script /exec URL)
const DEFAULT_EXEC =
  "https://script.google.com/macros/s/AKfycbzimb_rQvHZnO-KWwxG2xGvXhDylH1nHqCII5F9zmGr16SOwQ4EpM125RO7Ov1E_mIOqA/exec";

/* Use ?exec= to override (handy if you redeploy) */
const urlExec = new URLSearchParams(location.search).get("exec");
const BACKEND_URL = (urlExec && urlExec.startsWith("http")) ? urlExec : DEFAULT_EXEC;

/* -------------------- UI wire-up -------------------- */
const $ = (id) => document.getElementById(id);
const statusEl = $("status");
$("endpoint").textContent = "Backend: " + BACKEND_URL;

function setStatus(txt, cls) {
  statusEl.className = "status " + (cls || "");
  statusEl.textContent = txt;
}

/* -------------------- Camera open -------------------- */
let stream = null;
$("openCamera").addEventListener("click", async () => {
  try {
    setStatus("Requesting camera…");
    stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    $("cameraFeed").srcObject = stream;
    setStatus("Camera ready.", "ok");
  } catch (err) {
    setStatus("Camera access failed: " + err.message, "err");
  }
});

/* -------------------- Capture & send to Apps Script -------------------- */
$("snapSend").addEventListener("click", async () => {
  try {
    if (!stream) throw new Error("Open Camera first.");
    const video = $("cameraFeed");
    const canvas = $("frame");
    // size canvas to video frame
    const w = video.videoWidth || 1280, h = video.videoHeight || 720;
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, w, h);
    setStatus("Encoding…");
    const blob = await new Promise(res => canvas.toBlob(res, "image/jpeg", 0.92));
    const form = new FormData();
    form.append("file", blob, "quantcam.jpg");
    form.append("source", "QuantCam-PWA");
    setStatus("Uploading…");
    const r = await fetch(BACKEND_URL, { method: "POST", body: form });
    // Apps Script often returns text/plain
    const txt = await r.text();
    if (!r.ok) throw new Error(r.status + " " + txt);
    setStatus("Uploaded • Response: " + txt.slice(0, 400), "ok");
  } catch (err) {
    setStatus("Upload failed: " + err.message, "err");
  }
});

/* -------------------- Ping test -------------------- */
$("pingBtn").addEventListener("click", async () => {
  try {
    setStatus("Pinging…");
    const r = await fetch(BACKEND_URL + (BACKEND_URL.includes("?") ? "&" : "?") + "ping=1",
                          { method:"GET", cache:"no-cache" });
    const txt = await r.text();
    if (!r.ok) throw new Error(r.status + " " + txt);
    setStatus("Ping OK • " + txt.slice(0, 200), "ok");
  } catch (err) {
    setStatus("Ping failed: " + err.message, "err");
  }
});
</script>
</body>
</html>
